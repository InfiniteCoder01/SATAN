/// Central interrupt handler, all interrupts come here specifying an interrupt number
extern "C" fn interrupt_handler(interrupt: u8, error_code: usize) {
    if interrupt == 0x20 {
        // Timer
        return;
    }
    if interrupt == 0x0E {
        // Page fault
        crate::println!("Page fault!\nError code:\n{:#032b}", error_code);
        crate::println!("                ^        ^^IRUWP");
        crate::println!("               SGX      SSPK    ");
        panic!("Halt");
    }
    if interrupt == 0x21 {
        // Keyboard
        let scancode = unsafe { x86::io::inb(0x60) };
        crate::println!("Keyboard: {}", scancode);
        return;
    }
    if interrupt == 0x80 {
        // Syscall
        crate::println!("TEST: {}", 0);
        return;
    }
    if interrupt < 0x20 {
        panic!(
            "{}\nError code: {:#x}",
            x86::irq::EXCEPTIONS[interrupt as usize].description,
            error_code
        );
    }
    panic!(
        "Unknown interrupt: {:#x}\nError code: {:#x}",
        interrupt, error_code
    );
}

// -------------------------------- IDT
#[cfg(target_arch = "x86")]
type Descriptor = x86::segmentation::Descriptor;
#[cfg(target_arch = "x86_64")]
type Descriptor = x86::bits64::segmentation::Descriptor64;

static mut IDT: [Descriptor; 256] = [Descriptor::NULL; 256];
static mut IDTR: Option<x86::dtables::DescriptorTablePointer<Descriptor>> = None;

// -------------------------------- All the interrupts
macro_rules! int {
    ($($name: ident($($params: tt),+),)*) => {
        $(
            int!($name($($params),+));
        )*
    };
    ($name: ident($no: literal)) => {
        extern "x86-interrupt" fn $name () {
            interrupt_handler($no, 0);
        }
    };
    ($name: ident($no: literal, ec)) => {
        extern "x86-interrupt" fn $name (error_code: usize) {
            interrupt_handler($no, error_code);
        }
    };
    ($name: ident($no: literal, m)) => {
        extern "x86-interrupt" fn $name () {
            unsafe {
                interrupt_handler($no, 0);
                x86::io::outb(0x20, 0x20);
            }
        }
    };
    ($name: ident($no: literal, s)) => {
        extern "x86-interrupt" fn $name () {
            unsafe {
                interrupt_handler($no, 0);
                x86::io::outb(0x20, 0x20);
                x86::io::outb(0xa0, 0x20);
            }
        }
    };
}

// Define all interrupts
// ec stands for error code, means that this interrupt pushes an error-code onto the stack
// m stands for master, which tells interrupt handler to send EOI to master PIC
// s stands for slave, which tells interrupt handler to send EOI to both master and slave PICs
int! {
    int_0x00(0x00), int_0x01(0x01), int_0x02(0x02), int_0x03(0x03), int_0x04(0x04), int_0x05(0x05), int_0x06(0x06), int_0x07(0x07), int_0x08(0x08, ec), int_0x09(0x09), int_0x0a(0x0a, ec), int_0x0b(0x0b, ec), int_0x0c(0x0c, ec), int_0x0d(0x0d, ec), int_0x0e(0x0e, ec), int_0x0f(0x0f),
    int_0x10(0x10), int_0x11(0x11, ec), int_0x12(0x12), int_0x13(0x13), int_0x14(0x14), int_0x15(0x15, ec), int_0x16(0x16), int_0x17(0x17), int_0x18(0x18), int_0x19(0x19), int_0x1a(0x1a), int_0x1b(0x1b), int_0x1c(0x1c), int_0x1d(0x1d, ec), int_0x1e(0x1e, ec), int_0x1f(0x1f),
    int_0x20(0x20, m), int_0x21(0x21, m), int_0x22(0x22, m), int_0x23(0x23, m), int_0x24(0x24, m), int_0x25(0x25, m), int_0x26(0x26, m), int_0x27(0x27, m), int_0x28(0x28, s), int_0x29(0x29, s), int_0x2a(0x2a, s), int_0x2b(0x2b, s), int_0x2c(0x2c, s), int_0x2d(0x2d, s), int_0x2e(0x2e, s), int_0x2f(0x2f, s),
    int_0x30(0x30), int_0x31(0x31), int_0x32(0x32), int_0x33(0x33), int_0x34(0x34), int_0x35(0x35), int_0x36(0x36), int_0x37(0x37), int_0x38(0x38), int_0x39(0x39), int_0x3a(0x3a), int_0x3b(0x3b), int_0x3c(0x3c), int_0x3d(0x3d), int_0x3e(0x3e), int_0x3f(0x3f),
    int_0x40(0x40), int_0x41(0x41), int_0x42(0x42), int_0x43(0x43), int_0x44(0x44), int_0x45(0x45), int_0x46(0x46), int_0x47(0x47), int_0x48(0x48), int_0x49(0x49), int_0x4a(0x4a), int_0x4b(0x4b), int_0x4c(0x4c), int_0x4d(0x4d), int_0x4e(0x4e), int_0x4f(0x4f),
    int_0x50(0x50), int_0x51(0x51), int_0x52(0x52), int_0x53(0x53), int_0x54(0x54), int_0x55(0x55), int_0x56(0x56), int_0x57(0x57), int_0x58(0x58), int_0x59(0x59), int_0x5a(0x5a), int_0x5b(0x5b), int_0x5c(0x5c), int_0x5d(0x5d), int_0x5e(0x5e), int_0x5f(0x5f),
    int_0x60(0x60), int_0x61(0x61), int_0x62(0x62), int_0x63(0x63), int_0x64(0x64), int_0x65(0x65), int_0x66(0x66), int_0x67(0x67), int_0x68(0x68), int_0x69(0x69), int_0x6a(0x6a), int_0x6b(0x6b), int_0x6c(0x6c), int_0x6d(0x6d), int_0x6e(0x6e), int_0x6f(0x6f),
    int_0x70(0x70), int_0x71(0x71), int_0x72(0x72), int_0x73(0x73), int_0x74(0x74), int_0x75(0x75), int_0x76(0x76), int_0x77(0x77), int_0x78(0x78), int_0x79(0x79), int_0x7a(0x7a), int_0x7b(0x7b), int_0x7c(0x7c), int_0x7d(0x7d), int_0x7e(0x7e), int_0x7f(0x7f),
    int_0x80(0x80), int_0x81(0x81), int_0x82(0x82), int_0x83(0x83), int_0x84(0x84), int_0x85(0x85), int_0x86(0x86), int_0x87(0x87), int_0x88(0x88), int_0x89(0x89), int_0x8a(0x8a), int_0x8b(0x8b), int_0x8c(0x8c), int_0x8d(0x8d), int_0x8e(0x8e), int_0x8f(0x8f),
    int_0x90(0x90), int_0x91(0x91), int_0x92(0x92), int_0x93(0x93), int_0x94(0x94), int_0x95(0x95), int_0x96(0x96), int_0x97(0x97), int_0x98(0x98), int_0x99(0x99), int_0x9a(0x9a), int_0x9b(0x9b), int_0x9c(0x9c), int_0x9d(0x9d), int_0x9e(0x9e), int_0x9f(0x9f),
    int_0xa0(0xa0), int_0xa1(0xa1), int_0xa2(0xa2), int_0xa3(0xa3), int_0xa4(0xa4), int_0xa5(0xa5), int_0xa6(0xa6), int_0xa7(0xa7), int_0xa8(0xa8), int_0xa9(0xa9), int_0xaa(0xaa), int_0xab(0xab), int_0xac(0xac), int_0xad(0xad), int_0xae(0xae), int_0xaf(0xaf),
    int_0xb0(0xb0), int_0xb1(0xb1), int_0xb2(0xb2), int_0xb3(0xb3), int_0xb4(0xb4), int_0xb5(0xb5), int_0xb6(0xb6), int_0xb7(0xb7), int_0xb8(0xb8), int_0xb9(0xb9), int_0xba(0xba), int_0xbb(0xbb), int_0xbc(0xbc), int_0xbd(0xbd), int_0xbe(0xbe), int_0xbf(0xbf),
    int_0xc0(0xc0), int_0xc1(0xc1), int_0xc2(0xc2), int_0xc3(0xc3), int_0xc4(0xc4), int_0xc5(0xc5), int_0xc6(0xc6), int_0xc7(0xc7), int_0xc8(0xc8), int_0xc9(0xc9), int_0xca(0xca), int_0xcb(0xcb), int_0xcc(0xcc), int_0xcd(0xcd), int_0xce(0xce), int_0xcf(0xcf),
    int_0xd0(0xd0), int_0xd1(0xd1), int_0xd2(0xd2), int_0xd3(0xd3), int_0xd4(0xd4), int_0xd5(0xd5), int_0xd6(0xd6), int_0xd7(0xd7), int_0xd8(0xd8), int_0xd9(0xd9), int_0xda(0xda), int_0xdb(0xdb), int_0xdc(0xdc), int_0xdd(0xdd), int_0xde(0xde), int_0xdf(0xdf),
    int_0xe0(0xe0), int_0xe1(0xe1), int_0xe2(0xe2), int_0xe3(0xe3), int_0xe4(0xe4), int_0xe5(0xe5), int_0xe6(0xe6), int_0xe7(0xe7), int_0xe8(0xe8), int_0xe9(0xe9), int_0xea(0xea), int_0xeb(0xeb), int_0xec(0xec), int_0xed(0xed), int_0xee(0xee), int_0xef(0xef),
    int_0xf0(0xf0), int_0xf1(0xf1), int_0xf2(0xf2), int_0xf3(0xf3), int_0xf4(0xf4), int_0xf5(0xf5), int_0xf6(0xf6), int_0xf7(0xf7), int_0xf8(0xf8), int_0xf9(0xf9), int_0xfa(0xfa), int_0xfb(0xfb), int_0xfc(0xfc), int_0xfd(0xfd), int_0xfe(0xfe), int_0xff(0xff),
}

/// Setup IDT and program the PIC
#[link_section = ".bootstrap"]
pub(super) fn setup() {
    #[cfg(target_arch = "x86")]
    type Address = u32;
    #[cfg(target_arch = "x86_64")]
    type Address = u64;

    fn make_desc(offset: Address) -> Descriptor {
        use x86::segmentation::{
            BuildDescriptor, DescriptorBuilder, GateDescriptorBuilder, SegmentSelector,
        };
        DescriptorBuilder::interrupt_descriptor(SegmentSelector::new(1, x86::Ring::Ring0), offset)
            .present()
            .finish()
    }

    unsafe {
        IDT[0x00] = make_desc(int_0x00 as _);
        IDT[0x01] = make_desc(int_0x01 as _);
        IDT[0x02] = make_desc(int_0x02 as _);
        IDT[0x03] = make_desc(int_0x03 as _);
        IDT[0x04] = make_desc(int_0x04 as _);
        IDT[0x05] = make_desc(int_0x05 as _);
        IDT[0x06] = make_desc(int_0x06 as _);
        IDT[0x07] = make_desc(int_0x07 as _);
        IDT[0x08] = make_desc(int_0x08 as _);
        IDT[0x09] = make_desc(int_0x09 as _);
        IDT[0x0a] = make_desc(int_0x0a as _);
        IDT[0x0b] = make_desc(int_0x0b as _);
        IDT[0x0c] = make_desc(int_0x0c as _);
        IDT[0x0d] = make_desc(int_0x0d as _);
        IDT[0x0e] = make_desc(int_0x0e as _);
        IDT[0x0f] = make_desc(int_0x0f as _);
        IDT[0x10] = make_desc(int_0x10 as _);
        IDT[0x11] = make_desc(int_0x11 as _);
        IDT[0x12] = make_desc(int_0x12 as _);
        IDT[0x13] = make_desc(int_0x13 as _);
        IDT[0x14] = make_desc(int_0x14 as _);
        IDT[0x15] = make_desc(int_0x15 as _);
        IDT[0x16] = make_desc(int_0x16 as _);
        IDT[0x17] = make_desc(int_0x17 as _);
        IDT[0x18] = make_desc(int_0x18 as _);
        IDT[0x19] = make_desc(int_0x19 as _);
        IDT[0x1a] = make_desc(int_0x1a as _);
        IDT[0x1b] = make_desc(int_0x1b as _);
        IDT[0x1c] = make_desc(int_0x1c as _);
        IDT[0x1d] = make_desc(int_0x1d as _);
        IDT[0x1e] = make_desc(int_0x1e as _);
        IDT[0x1f] = make_desc(int_0x1f as _);
        IDT[0x20] = make_desc(int_0x20 as _);
        IDT[0x21] = make_desc(int_0x21 as _);
        IDT[0x22] = make_desc(int_0x22 as _);
        IDT[0x23] = make_desc(int_0x23 as _);
        IDT[0x24] = make_desc(int_0x24 as _);
        IDT[0x25] = make_desc(int_0x25 as _);
        IDT[0x26] = make_desc(int_0x26 as _);
        IDT[0x27] = make_desc(int_0x27 as _);
        IDT[0x28] = make_desc(int_0x28 as _);
        IDT[0x29] = make_desc(int_0x29 as _);
        IDT[0x2a] = make_desc(int_0x2a as _);
        IDT[0x2b] = make_desc(int_0x2b as _);
        IDT[0x2c] = make_desc(int_0x2c as _);
        IDT[0x2d] = make_desc(int_0x2d as _);
        IDT[0x2e] = make_desc(int_0x2e as _);
        IDT[0x2f] = make_desc(int_0x2f as _);
        IDT[0x30] = make_desc(int_0x30 as _);
        IDT[0x31] = make_desc(int_0x31 as _);
        IDT[0x32] = make_desc(int_0x32 as _);
        IDT[0x33] = make_desc(int_0x33 as _);
        IDT[0x34] = make_desc(int_0x34 as _);
        IDT[0x35] = make_desc(int_0x35 as _);
        IDT[0x36] = make_desc(int_0x36 as _);
        IDT[0x37] = make_desc(int_0x37 as _);
        IDT[0x38] = make_desc(int_0x38 as _);
        IDT[0x39] = make_desc(int_0x39 as _);
        IDT[0x3a] = make_desc(int_0x3a as _);
        IDT[0x3b] = make_desc(int_0x3b as _);
        IDT[0x3c] = make_desc(int_0x3c as _);
        IDT[0x3d] = make_desc(int_0x3d as _);
        IDT[0x3e] = make_desc(int_0x3e as _);
        IDT[0x3f] = make_desc(int_0x3f as _);
        IDT[0x40] = make_desc(int_0x40 as _);
        IDT[0x41] = make_desc(int_0x41 as _);
        IDT[0x42] = make_desc(int_0x42 as _);
        IDT[0x43] = make_desc(int_0x43 as _);
        IDT[0x44] = make_desc(int_0x44 as _);
        IDT[0x45] = make_desc(int_0x45 as _);
        IDT[0x46] = make_desc(int_0x46 as _);
        IDT[0x47] = make_desc(int_0x47 as _);
        IDT[0x48] = make_desc(int_0x48 as _);
        IDT[0x49] = make_desc(int_0x49 as _);
        IDT[0x4a] = make_desc(int_0x4a as _);
        IDT[0x4b] = make_desc(int_0x4b as _);
        IDT[0x4c] = make_desc(int_0x4c as _);
        IDT[0x4d] = make_desc(int_0x4d as _);
        IDT[0x4e] = make_desc(int_0x4e as _);
        IDT[0x4f] = make_desc(int_0x4f as _);
        IDT[0x50] = make_desc(int_0x50 as _);
        IDT[0x51] = make_desc(int_0x51 as _);
        IDT[0x52] = make_desc(int_0x52 as _);
        IDT[0x53] = make_desc(int_0x53 as _);
        IDT[0x54] = make_desc(int_0x54 as _);
        IDT[0x55] = make_desc(int_0x55 as _);
        IDT[0x56] = make_desc(int_0x56 as _);
        IDT[0x57] = make_desc(int_0x57 as _);
        IDT[0x58] = make_desc(int_0x58 as _);
        IDT[0x59] = make_desc(int_0x59 as _);
        IDT[0x5a] = make_desc(int_0x5a as _);
        IDT[0x5b] = make_desc(int_0x5b as _);
        IDT[0x5c] = make_desc(int_0x5c as _);
        IDT[0x5d] = make_desc(int_0x5d as _);
        IDT[0x5e] = make_desc(int_0x5e as _);
        IDT[0x5f] = make_desc(int_0x5f as _);
        IDT[0x60] = make_desc(int_0x60 as _);
        IDT[0x61] = make_desc(int_0x61 as _);
        IDT[0x62] = make_desc(int_0x62 as _);
        IDT[0x63] = make_desc(int_0x63 as _);
        IDT[0x64] = make_desc(int_0x64 as _);
        IDT[0x65] = make_desc(int_0x65 as _);
        IDT[0x66] = make_desc(int_0x66 as _);
        IDT[0x67] = make_desc(int_0x67 as _);
        IDT[0x68] = make_desc(int_0x68 as _);
        IDT[0x69] = make_desc(int_0x69 as _);
        IDT[0x6a] = make_desc(int_0x6a as _);
        IDT[0x6b] = make_desc(int_0x6b as _);
        IDT[0x6c] = make_desc(int_0x6c as _);
        IDT[0x6d] = make_desc(int_0x6d as _);
        IDT[0x6e] = make_desc(int_0x6e as _);
        IDT[0x6f] = make_desc(int_0x6f as _);
        IDT[0x70] = make_desc(int_0x70 as _);
        IDT[0x71] = make_desc(int_0x71 as _);
        IDT[0x72] = make_desc(int_0x72 as _);
        IDT[0x73] = make_desc(int_0x73 as _);
        IDT[0x74] = make_desc(int_0x74 as _);
        IDT[0x75] = make_desc(int_0x75 as _);
        IDT[0x76] = make_desc(int_0x76 as _);
        IDT[0x77] = make_desc(int_0x77 as _);
        IDT[0x78] = make_desc(int_0x78 as _);
        IDT[0x79] = make_desc(int_0x79 as _);
        IDT[0x7a] = make_desc(int_0x7a as _);
        IDT[0x7b] = make_desc(int_0x7b as _);
        IDT[0x7c] = make_desc(int_0x7c as _);
        IDT[0x7d] = make_desc(int_0x7d as _);
        IDT[0x7e] = make_desc(int_0x7e as _);
        IDT[0x7f] = make_desc(int_0x7f as _);
        IDT[0x80] = make_desc(int_0x80 as _);
        IDT[0x81] = make_desc(int_0x81 as _);
        IDT[0x82] = make_desc(int_0x82 as _);
        IDT[0x83] = make_desc(int_0x83 as _);
        IDT[0x84] = make_desc(int_0x84 as _);
        IDT[0x85] = make_desc(int_0x85 as _);
        IDT[0x86] = make_desc(int_0x86 as _);
        IDT[0x87] = make_desc(int_0x87 as _);
        IDT[0x88] = make_desc(int_0x88 as _);
        IDT[0x89] = make_desc(int_0x89 as _);
        IDT[0x8a] = make_desc(int_0x8a as _);
        IDT[0x8b] = make_desc(int_0x8b as _);
        IDT[0x8c] = make_desc(int_0x8c as _);
        IDT[0x8d] = make_desc(int_0x8d as _);
        IDT[0x8e] = make_desc(int_0x8e as _);
        IDT[0x8f] = make_desc(int_0x8f as _);
        IDT[0x90] = make_desc(int_0x90 as _);
        IDT[0x91] = make_desc(int_0x91 as _);
        IDT[0x92] = make_desc(int_0x92 as _);
        IDT[0x93] = make_desc(int_0x93 as _);
        IDT[0x94] = make_desc(int_0x94 as _);
        IDT[0x95] = make_desc(int_0x95 as _);
        IDT[0x96] = make_desc(int_0x96 as _);
        IDT[0x97] = make_desc(int_0x97 as _);
        IDT[0x98] = make_desc(int_0x98 as _);
        IDT[0x99] = make_desc(int_0x99 as _);
        IDT[0x9a] = make_desc(int_0x9a as _);
        IDT[0x9b] = make_desc(int_0x9b as _);
        IDT[0x9c] = make_desc(int_0x9c as _);
        IDT[0x9d] = make_desc(int_0x9d as _);
        IDT[0x9e] = make_desc(int_0x9e as _);
        IDT[0x9f] = make_desc(int_0x9f as _);
        IDT[0xa0] = make_desc(int_0xa0 as _);
        IDT[0xa1] = make_desc(int_0xa1 as _);
        IDT[0xa2] = make_desc(int_0xa2 as _);
        IDT[0xa3] = make_desc(int_0xa3 as _);
        IDT[0xa4] = make_desc(int_0xa4 as _);
        IDT[0xa5] = make_desc(int_0xa5 as _);
        IDT[0xa6] = make_desc(int_0xa6 as _);
        IDT[0xa7] = make_desc(int_0xa7 as _);
        IDT[0xa8] = make_desc(int_0xa8 as _);
        IDT[0xa9] = make_desc(int_0xa9 as _);
        IDT[0xaa] = make_desc(int_0xaa as _);
        IDT[0xab] = make_desc(int_0xab as _);
        IDT[0xac] = make_desc(int_0xac as _);
        IDT[0xad] = make_desc(int_0xad as _);
        IDT[0xae] = make_desc(int_0xae as _);
        IDT[0xaf] = make_desc(int_0xaf as _);
        IDT[0xb0] = make_desc(int_0xb0 as _);
        IDT[0xb1] = make_desc(int_0xb1 as _);
        IDT[0xb2] = make_desc(int_0xb2 as _);
        IDT[0xb3] = make_desc(int_0xb3 as _);
        IDT[0xb4] = make_desc(int_0xb4 as _);
        IDT[0xb5] = make_desc(int_0xb5 as _);
        IDT[0xb6] = make_desc(int_0xb6 as _);
        IDT[0xb7] = make_desc(int_0xb7 as _);
        IDT[0xb8] = make_desc(int_0xb8 as _);
        IDT[0xb9] = make_desc(int_0xb9 as _);
        IDT[0xba] = make_desc(int_0xba as _);
        IDT[0xbb] = make_desc(int_0xbb as _);
        IDT[0xbc] = make_desc(int_0xbc as _);
        IDT[0xbd] = make_desc(int_0xbd as _);
        IDT[0xbe] = make_desc(int_0xbe as _);
        IDT[0xbf] = make_desc(int_0xbf as _);
        IDT[0xc0] = make_desc(int_0xc0 as _);
        IDT[0xc1] = make_desc(int_0xc1 as _);
        IDT[0xc2] = make_desc(int_0xc2 as _);
        IDT[0xc3] = make_desc(int_0xc3 as _);
        IDT[0xc4] = make_desc(int_0xc4 as _);
        IDT[0xc5] = make_desc(int_0xc5 as _);
        IDT[0xc6] = make_desc(int_0xc6 as _);
        IDT[0xc7] = make_desc(int_0xc7 as _);
        IDT[0xc8] = make_desc(int_0xc8 as _);
        IDT[0xc9] = make_desc(int_0xc9 as _);
        IDT[0xca] = make_desc(int_0xca as _);
        IDT[0xcb] = make_desc(int_0xcb as _);
        IDT[0xcc] = make_desc(int_0xcc as _);
        IDT[0xcd] = make_desc(int_0xcd as _);
        IDT[0xce] = make_desc(int_0xce as _);
        IDT[0xcf] = make_desc(int_0xcf as _);
        IDT[0xd0] = make_desc(int_0xd0 as _);
        IDT[0xd1] = make_desc(int_0xd1 as _);
        IDT[0xd2] = make_desc(int_0xd2 as _);
        IDT[0xd3] = make_desc(int_0xd3 as _);
        IDT[0xd4] = make_desc(int_0xd4 as _);
        IDT[0xd5] = make_desc(int_0xd5 as _);
        IDT[0xd6] = make_desc(int_0xd6 as _);
        IDT[0xd7] = make_desc(int_0xd7 as _);
        IDT[0xd8] = make_desc(int_0xd8 as _);
        IDT[0xd9] = make_desc(int_0xd9 as _);
        IDT[0xda] = make_desc(int_0xda as _);
        IDT[0xdb] = make_desc(int_0xdb as _);
        IDT[0xdc] = make_desc(int_0xdc as _);
        IDT[0xdd] = make_desc(int_0xdd as _);
        IDT[0xde] = make_desc(int_0xde as _);
        IDT[0xdf] = make_desc(int_0xdf as _);
        IDT[0xe0] = make_desc(int_0xe0 as _);
        IDT[0xe1] = make_desc(int_0xe1 as _);
        IDT[0xe2] = make_desc(int_0xe2 as _);
        IDT[0xe3] = make_desc(int_0xe3 as _);
        IDT[0xe4] = make_desc(int_0xe4 as _);
        IDT[0xe5] = make_desc(int_0xe5 as _);
        IDT[0xe6] = make_desc(int_0xe6 as _);
        IDT[0xe7] = make_desc(int_0xe7 as _);
        IDT[0xe8] = make_desc(int_0xe8 as _);
        IDT[0xe9] = make_desc(int_0xe9 as _);
        IDT[0xea] = make_desc(int_0xea as _);
        IDT[0xeb] = make_desc(int_0xeb as _);
        IDT[0xec] = make_desc(int_0xec as _);
        IDT[0xed] = make_desc(int_0xed as _);
        IDT[0xee] = make_desc(int_0xee as _);
        IDT[0xef] = make_desc(int_0xef as _);
        IDT[0xf0] = make_desc(int_0xf0 as _);
        IDT[0xf1] = make_desc(int_0xf1 as _);
        IDT[0xf2] = make_desc(int_0xf2 as _);
        IDT[0xf3] = make_desc(int_0xf3 as _);
        IDT[0xf4] = make_desc(int_0xf4 as _);
        IDT[0xf5] = make_desc(int_0xf5 as _);
        IDT[0xf6] = make_desc(int_0xf6 as _);
        IDT[0xf7] = make_desc(int_0xf7 as _);
        IDT[0xf8] = make_desc(int_0xf8 as _);
        IDT[0xf9] = make_desc(int_0xf9 as _);
        IDT[0xfa] = make_desc(int_0xfa as _);
        IDT[0xfb] = make_desc(int_0xfb as _);
        IDT[0xfc] = make_desc(int_0xfc as _);
        IDT[0xfd] = make_desc(int_0xfd as _);
        IDT[0xfe] = make_desc(int_0xfe as _);
        IDT[0xff] = make_desc(int_0xff as _);

        #[allow(static_mut_refs)]
        let idtr = IDTR.insert(x86::dtables::DescriptorTablePointer::new_from_slice(&IDT));
        x86::dtables::lidt(&idtr);

        // Programming PIC
        x86::io::outb(0x20, 0x11); // Remap master PIC
        x86::io::outb(0xa0, 0x11); // Remap slave PIC
        x86::io::outb(0x21, 0x20); // Master PIC offset 0x20
        x86::io::outb(0xa1, 0x28); // Slave PIC offset 0x28
        x86::io::outb(0x21, 4); // Tell master PIC that there is a slave PIC at IRQ2 (0000 0100)
        x86::io::outb(0xa1, 2); // Tell slave PIC its cascade identity (0000 0010)
        x86::io::outb(0x21, 0x01); // 8086 mode
        x86::io::outb(0xa1, 0x01); // 8086 mode
        x86::io::outb(0x21, 0x00); // Master PIC mask
        x86::io::outb(0xa1, 0x00); // Slave PIC mask
        x86::irq::enable();
    }
    crate::println!("IDT is setup");
}
